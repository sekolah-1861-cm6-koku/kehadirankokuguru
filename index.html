<!doctype html>
<html lang="ms">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Kehadiran Koku SKBTHO 2</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #fef2f2; min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px; }
        .canva-card { background: white; width: 100%; max-width: 450px; padding: 30px 25px; border-radius: 35px; box-shadow: 0 25px 50px -12px rgba(220, 38, 38, 0.15); text-align: center; border-top: 10px solid #dc2626; position: relative; overflow: hidden; }
        .logo-img { width: 100px; margin: 0 auto 15px auto; display: block; }
        .select-style { width: 100%; padding: 14px; border: 2px solid #fee2e2; border-radius: 15px; margin-bottom: 20px; font-weight: 600; background-color: white; color: #374151; appearance: none; cursor: pointer; }
        .select-style option.done { background-color: #d1fae5 !important; color: #065f46 !important; } 
        .btn-detect { background-color: #4b5563; color: white; padding: 15px; border-radius: 15px; width: 100%; font-weight: 600; margin-bottom: 12px; }
        .btn-clockin { background-color: #dc2626; color: white; padding: 18px; border-radius: 15px; width: 100%; font-weight: 700; box-shadow: 0 10px 15px -3px rgba(220, 38, 38, 0.4); }
        .btn-clockin:disabled { background-color: #fca5a5; opacity: 0.7; }
        .btn-admin { position: absolute; top: 15px; right: 15px; font-size: 9px; color: #fca5a5; cursor: pointer; border: 1px solid #fee2e2; padding: 4px 8px; border-radius: 8px; font-weight: bold; }
        .lock-overlay { background: rgba(255,255,255,0.98); border-radius: 35px; position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; padding: 20px; }
    </style>
</head>
<body>

<div class="canva-card">
    <div class="btn-admin" onclick="adminControl()">ADMIN SYSTEM</div>
    
    <div id="lockScreen" class="lock-overlay hidden">
        <span id="lockIcon" class="text-6xl mb-4">üîí</span>
        <h2 id="lockTitle" class="text-2xl font-bold text-red-600 uppercase">Sistem Ditutup</h2>
        <p id="lockReason" class="text-sm text-gray-500 mt-2 text-center">Kehadiran hanya dibuka pada jam 3:30 PM - 6:00 PM sahaja.</p>
    </div>

    <img src="https://imgur.com/DLy3jZn.png" class="logo-img">
    <h1 class="text-lg font-bold text-gray-800 leading-tight">Clock In Kokurikulum</h1>
    <p class="text-red-600 font-bold text-xs mb-6 uppercase">SK Bandar Tun Hussein Onn 2</p>

    <div id="formSection">
        <div class="text-left">
            <label class="text-xs font-bold text-gray-500 uppercase ml-2">Pilih Nama Anda</label>
            <select id="teacherName" class="select-style">
                <option value="">-- MEMUAT NAMA... --</option>
            </select>
        </div>
        <button id="detectBtn" class="btn-detect" onclick="detectLocation()">üîç SAHKAN LOKASI SAYA</button>
        <button id="inBtn" class="btn-clockin" onclick="saveRecord()" disabled>CLOCK IN</button>
    </div>

    <div id="blockSection" class="hidden py-4 text-green-700 font-bold bg-green-50 rounded-2xl border border-green-100 mt-4 text-sm">
        ‚úÖ REKOD PERANTI INI TELAH DIHANTAR.
    </div>
    
    <div id="distanceWrapper" class="hidden mt-4 p-3 bg-red-50 rounded-xl border border-red-100">
        <p id="infoJarak" class="text-xs text-red-700 font-bold italic"></p>
    </div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbxrJAvYuqsYEyCjjOYI75DYa5jGs2MwYr_ad7ms1M8jQYd4Ca64CkQPi_Agf1-v_590/exec";
    const senaraiGuru = ["ABDUL KAHAR BIN AWANG SEMAN", "AINA ATHIRAH BINTI AHMAD SENARI", "AMIRAH BINTI MOHD ALWI", "AMINUDDIN BIN ISMAIL", "ARINAWATI BINTI MOHD YAH", "AWATIF BINTI MD YUSOP", "AZHAIRIN ZULAIHAN BINTI BADRUL HISHAM", "AZIMA BINTI MAT ZIN @ ISMAIL", "AZIZAH BINTI MOHAMMED", "AZMAN BIN OTHMAN", "DINITA A/P MUNIANDY", "EMIL NORULHUDA BINTI AMIRUDDIN", "FAIZA BINTI HASBULLAH", "FAIZAH BINTI IBRAHIM", "FARAWAHIDA BINTI MOHD SAFFUAN", "FARIDATUL AKMAAR BINTI MAT SAID", "FATIN FARHANA BINTI AMINUDDIN", "HAFIZI BIN OMAR", "HARISAH BINTI AWANG", "HARIZ IRFAN BIN HUSSIN PAKRI", "HASMAWATI BINTI OTHMAN", "HAZRAH BINTI MOHAMAD", "IRDINA AFIQAH BINTI ISMAIL", "IRMA AZNITA BINTI KAMBALI", "KANG CHIN KOAT", "KASUMMA BINTI PANDAK KAMAL", "MARYANI BINTI DRAMAN", "MAWADDAH HUDA BINTI MOHD AFFANDI", "MAZILA HAZLIN BINTI ABD MAJIT", "MOHAMAD MUNIR BIN ZAINUN", "MOHAMED SYAKIR BIN MD TAHIR", "MOHD SHAMILULHAYAT BIN MOHD ASRI", "MUHAMMAD AKASYAH SAIDON", "MUHAMMAD IRFAN WAZIF BIN MOHD NIZAM", "NADIAH BINTI IDRIS", "NAIM AISAMUDDIN BIN ABDUL RAZAK", "NAZIMATUL AMANI BINTI RAMLI", "NIK HAZIMAN BIN CHE DAUD", "NIK NUR LIYANA BINTI NIK FAUZI", "NITHILA A/P JAKANATHAN", "NOOR AZIZAH BINTI MD BAHARUDDIN", "NORAIDA BINTI MUSTAPHA", "NORAMANI BINTI MAT NOR", "NORMA BINTI ISMAIL", "NORUL HUDA BINTI JAMIN", "NOUR EZIEZAH BINTI MAZMAN", "NUR FATHIN BINTI ZAKI", "NUR SYAFIQAH BINTI ZAHIRUDDIN", "NUR ZURIYATIE BINTI AZIZ", "NURUL HAZIQAH BINTI RAMLI", "NURUL ULYA BINTI NORDIN", "PIRAKAS A/L SHANGAR", "ROHAIZA BINTI RAZALI", "ROSNAH BINTI JANTAN", "RUBINA BINTI RAMLI", "SAHARINA BINTI ABDULLAH", "SITI HAWA BINTI MAT YAJID", "SITI MASHITAH BINTI MOHD ASRI", "SITI NORASYIKIN BINTI ABDULLAH", "SITI NUR DIANA BINTI MOHAMAD NASIR", "SULAIMAN BIN HASSAN", "SUZILA BINTI MOHD NOR", "TG IHTIFAZUDDIN BIN TG IBRAHIM", "UMI NUR HANIRA BINTI ISMAIL", "WAN FAIRIS BIN A. KAMAR", "ZABIDI BIN MOHAMMAD", "ZANIRAH BINTI A. BAKAR"];

    window.onload = async function() {
        checkAutoLock(); 

        if(localStorage.getItem('skbtho2_submitted') === 'true') {
            document.getElementById('formSection').classList.add('hidden');
            document.getElementById('blockSection').classList.remove('hidden');
        }
        
        try {
            const resp = await fetch(WEB_APP_URL);
            const namesDone = await resp.json();
            const select = document.getElementById('teacherName');
            select.innerHTML = '<option value="">-- SILA PILIH NAMA --</option>';
            senaraiGuru.sort().forEach(nama => {
                let opt = document.createElement('option');
                opt.value = nama;
                opt.innerHTML = namesDone.includes(nama) ? "‚úÖ " + nama : nama;
                if(namesDone.includes(nama)) opt.className = 'done';
                select.appendChild(opt);
            });
        } catch(e) {
            console.log("Names load error");
        }
    }

    function checkAutoLock() {
        const now = new Date();
        const hour = now.getHours();
        const minutes = now.getMinutes();
        const currentTime = hour + (minutes / 60);

        // LOGIK BARU: Dibuka hanya antara jam 15.5 (3:30 PM) dan 18.0 (6:00 PM)
        const isTimeRange = (currentTime >= 15.5 && currentTime < 18);
        
        if (!isTimeRange) {
            document.getElementById('lockScreen').classList.remove('hidden');
            if (currentTime < 15.5) {
                document.getElementById('lockReason').innerText = "Sistem akan dibuka secara automatik pada jam 3:30 petang.";
            } else {
                document.getElementById('lockReason').innerText = "Sistem telah ditutup secara automatik pada jam 6:00 petang.";
            }
        } 
        // Jika Admin kunci manual, ia tetap sekat
        else if (localStorage.getItem('system_locked_manual') === 'true') {
            document.getElementById('lockScreen').classList.remove('hidden');
            document.getElementById('lockReason').innerText = "Sistem telah ditutup secara manual oleh Admin.";
        }
    }

    function adminControl() {
        const pass = prompt("PASSCODE ADMIN:");
        if(pass === "KOKU4055") {
            const cmd = prompt("TAIP 'AKTIF' UNTUK BUKA\nTAIP 'NYAHAKTIF' UNTUK TUTUP");
            if(cmd && cmd.toUpperCase() === 'AKTIF') {
                localStorage.setItem('system_locked_manual', 'false');
                alert("SISTEM DIAKTIFKAN (Status auto-lock waktu tetap berjalan).");
                location.reload();
            } else if(cmd && cmd.toUpperCase() === 'NYAHAKTIF') {
                localStorage.setItem('system_locked_manual', 'true');
                alert("SISTEM DINYAHAKTIFKAN.");
                location.reload();
            }
        } else if(pass !== null) { alert("SALAH!"); }
    }

    function detectLocation() {
        navigator.geolocation.getCurrentPosition((pos) => {
            const dist = calculateDistance(3.023221, 101.761705, pos.coords.latitude, pos.coords.longitude);
            document.getElementById('distanceWrapper').classList.remove('hidden');
            document.getElementById('infoJarak').innerText = "JARAK: " + Math.round(dist) + " METER";
            if (dist <= 500) { document.getElementById('inBtn').disabled = false; alert("LOKASI DISAHKAN!"); }
            else { alert("ANDA DI LUAR KAWASAN!"); }
        }, () => alert("Sila benarkan akses GPS."), { enableHighAccuracy: true });
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 6371e3;
        const d1 = lat1 * Math.PI/180; const d2 = lat2 * Math.PI/180;
        const df = (lat2-lat1) * Math.PI/180; const dl = (lon2-lon1) * Math.PI/180;
        const a = Math.sin(df/2) * Math.sin(df/2) + Math.cos(d1) * Math.cos(d2) * Math.sin(dl/2) * Math.sin(dl/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function saveRecord() {
        const nama = document.getElementById('teacherName').value;
        if (!nama) return alert("Pilih nama!");
        document.getElementById('inBtn').innerText = "MENGHANTAR...";
        document.getElementById('inBtn').disabled = true;
        fetch(WEB_APP_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify({ nama: nama, status: "CLOCK-IN KOKO", deviceId: localStorage.getItem('skbtho2_dev_id') || 'DEV' })
        }).then(() => {
            localStorage.setItem('skbtho2_submitted', 'true');
            alert("BERJAYA!");
            location.reload();
        });
    }
</script>
</body>
</html>
