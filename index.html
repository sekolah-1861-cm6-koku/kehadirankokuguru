window.onload = async function() {
        const today = new Date().toLocaleDateString(); // Ambil tarikh hari ini
        const lastSubmitDate = localStorage.getItem('last_submit_date');

        // Semak status lock admin
        if(localStorage.getItem('manual_lock') === 'true') {
            document.getElementById('lockScreen').classList.remove('hidden');
        }

        // LOGIK BARU: Hanya sekat jika tarikh hantar adalah TARIKH HARI INI
        if(lastSubmitDate === today) {
            document.getElementById('formSection').classList.add('hidden');
            document.getElementById('blockSection').classList.remove('hidden');
        }

        const select = document.getElementById('teacherName');
        try {
            const resp = await fetch(WEB_APP_URL);
            const namesDone = await resp.json();
            
            select.innerHTML = '<option value="">-- SILA PILIH NAMA --</option>';
            senaraiGuru.sort().forEach(nama => {
                let opt = document.createElement('option');
                opt.value = nama;
                opt.innerHTML = namesDone.includes(nama) ? "âœ… " + nama : nama;
                if(namesDone.includes(nama)) opt.className = 'done';
                select.appendChild(opt);
            });
        } catch(e) {
            // Fail-safe jika internet slow
            select.innerHTML = '<option value="">-- SILA PILIH NAMA --</option>';
            senaraiGuru.sort().forEach(nama => {
                let opt = document.createElement('option');
                opt.value = nama;
                opt.innerHTML = nama;
                select.appendChild(opt);
            });
        }
    }

    function saveRecord() {
        const nama = document.getElementById('teacherName').value;
        const today = new Date().toLocaleDateString(); // Ambil tarikh untuk disimpan
        
        if (!nama) return alert("Pilih nama!");
        
        document.getElementById('inBtn').innerText = "MENGHANTAR...";
        document.getElementById('inBtn').disabled = true;

        fetch(WEB_APP_URL, {
            method: "POST",
            mode: "no-cors",
            body: JSON.stringify({ 
                nama: nama, 
                status: "CLOCK-IN KOKO", 
                deviceId: "DEV-SKBTHO2" 
            })
        }).then(() => {
            // SIMPAN TARIKH HARI INI
            localStorage.setItem('last_submit_date', today); 
            alert("KEHADIRAN BERJAYA DIHANTAR!");
            location.reload();
        }).catch(err => {
            alert("Ralat penghantaran. Cuba lagi.");
            document.getElementById('inBtn').disabled = false;
        });
    }
