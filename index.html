<!doctype html>
<html lang="ms" class="h-full">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Geofencing Attendance System</title>
  <script src="/_sdk/data_sdk.js"></script>
  <script src="/_sdk/element_sdk.js"></script>
  <style>
        body {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100%;
            color: #1a202c;
        }

        html, body {
            height: 100%;
        }

        .app-container {
            width: 100%;
            min-height: 100%;
            overflow-auto;
            padding: max(20px, env(safe-area-inset-top)) max(20px, env(safe-area-inset-right)) max(20px, env(safe-area-inset-bottom)) max(20px, env(safe-area-inset-left));
        }

        .content-wrapper {
            max-width: 600px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            padding: 25px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
            text-align: center;
        }

        .system-title {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
            margin: 0 0 10px 0;
        }

        .school-name {
            font-size: 1.2rem;
            color: #4a5568;
            margin: 0 0 15px 0;
        }

        .welcome-message {
            background: #f0f4ff;
            padding: 12px;
            border-radius: 10px;
            color: #4c51bf;
            font-weight: 500;
            border-left: 4px solid #667eea;
        }

        .main-card {
            background: white;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            margin-bottom: 20px;
        }

        .status-banner {
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            font-weight: bold;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .status-idle {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
            color: #3730a3;
            border: 2px solid #818cf8;
        }

        .status-loading {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border: 2px solid #fbbf24;
        }

        .status-success {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            color: #065f46;
            border: 2px solid #34d399;
        }

        .status-error {
            background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
            color: #991b1b;
            border: 2px solid #f87171;
        }

        .form-section {
            margin-bottom: 25px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
            font-size: 1rem;
        }

        .form-input {
            width: 100%;
            padding: 14px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 16px;
            box-sizing: border-box;
            transition: all 0.3s ease;
            background: #f7fafc;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .location-info {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 12px;
            margin: 20px 0;
            border-left: 4px solid #0284c7;
        }

        .location-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid #e0f2fe;
        }

        .location-row:last-child {
            border-bottom: none;
        }

        .location-label {
            font-weight: 600;
            color: #0c4a6e;
        }

        .location-value {
            color: #075985;
            font-family: 'Courier New', monospace;
        }

        .distance-badge {
            display: inline-block;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.1rem;
        }

        .distance-inside {
            background: #d1fae5;
            color: #065f46;
            border: 2px solid #34d399;
        }

        .distance-outside {
            background: #fee2e2;
            color: #991b1b;
            border: 2px solid #f87171;
        }

        .action-buttons {
            display: flex;
            gap: 15px;
            margin: 25px 0;
            flex-wrap: wrap;
        }

        .btn {
            flex: 1;
            min-width: 140px;
            padding: 16px 24px;
            border: none;
            border-radius: 12px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        .btn-primary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(16, 185, 129, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
        }

        .btn-info {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(59, 130, 246, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .records-section {
            margin-top: 20px;
        }

        .section-title {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2d3748;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .record-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            border-left: 5px solid #667eea;
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }

        .record-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
        }

        .record-badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: bold;
        }

        .badge-checkin {
            background: #d1fae5;
            color: #065f46;
        }

        .badge-checkout {
            background: #fee2e2;
            color: #991b1b;
        }

        .record-details {
            color: #4a5568;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .record-location {
            background: #f0f9ff;
            padding: 10px;
            border-radius: 8px;
            margin-top: 10px;
            font-size: 0.9rem;
            color: #075985;
        }

        .info-box {
            background: #fffbeb;
            border: 2px solid #fbbf24;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .info-title {
            font-weight: bold;
            color: #92400e;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .info-text {
            color: #78350f;
            line-height: 1.6;
        }

        .geofence-settings {
            background: #f0fdf4;
            border: 2px solid #22c55e;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
        }

        .settings-title {
            font-weight: bold;
            color: #14532d;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }

        .settings-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #bbf7d0;
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-weight: 600;
            color: #166534;
        }

        .settings-value {
            color: #15803d;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #64748b;
        }

        .empty-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }

        @media (max-width: 768px) {
            .system-title {
                font-size: 1.6rem;
            }

            .action-buttons {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                min-width: auto;
            }

            .record-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
    </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body class="h-full">
  <div class="app-container h-full">
   <div class="content-wrapper"><!-- Header -->
    <header class="header">
     <h1 class="system-title" id="systemTitle">Sistem Kehadiran Geofencing</h1>
     <p class="school-name" id="schoolName">Sekolah Kebangsaan</p>
     <div class="welcome-message" id="welcomeMessage">
      üìç Check-in dengan lokasi GPS yang tepat!
     </div>
    </header><!-- Main Card -->
    <div class="main-card"><!-- Status Banner -->
     <div id="statusBanner" class="status-banner status-idle"><span>üìç</span> <span>Sedia untuk check-in/check-out</span>
     </div><!-- Geofence Settings Info -->
     <div class="geofence-settings">
      <div class="settings-title">
       ‚öôÔ∏è Tetapan Geofencing
      </div>
      <div class="settings-row"><span class="settings-label">üìç Lokasi Sekolah:</span> <span class="settings-value" id="schoolCoords">3.1390¬∞ N, 101.6869¬∞ E</span>
      </div>
      <div class="settings-row"><span class="settings-label">üìè Radius Dibenarkan:</span> <span class="settings-value">100 meter</span>
      </div>
      <div class="settings-row"><span class="settings-label">üéØ Status GPS:</span> <span class="settings-value" id="gpsStatus">Menunggu...</span>
      </div>
     </div><!-- Form Section -->
     <div class="form-section">
      <div class="form-group"><label for="teacherName" class="form-label">üë§ Nama Penuh Guru:</label> <input type="text" id="teacherName" class="form-input" placeholder="Contoh: Cikgu Ahmad bin Ali">
      </div>
      <div class="form-group"><label for="teacherId" class="form-label">üÜî ID/No. Pekerja:</label> <input type="text" id="teacherId" class="form-input" placeholder="Contoh: T001234">
      </div>
     </div><!-- Location Info (Hidden by default) -->
     <div id="locationInfo" class="location-info" style="display: none;">
      <div style="font-weight: bold; color: #0c4a6e; margin-bottom: 12px; font-size: 1.1rem;">
       üì° Maklumat Lokasi Semasa
      </div>
      <div class="location-row"><span class="location-label">Latitude:</span> <span class="location-value" id="currentLat">-</span>
      </div>
      <div class="location-row"><span class="location-label">Longitude:</span> <span class="location-value" id="currentLng">-</span>
      </div>
      <div class="location-row"><span class="location-label">Jarak dari sekolah:</span> <span class="location-value" id="distanceValue">-</span>
      </div>
      <div class="location-row"><span class="location-label">Status Lokasi:</span> <span id="locationStatus" class="distance-badge">-</span>
      </div>
     </div><!-- Info Box -->
     <div class="info-box">
      <div class="info-title">
       ‚ÑπÔ∏è Cara Penggunaan
      </div>
      <div class="info-text">
       1Ô∏è‚É£ Isi nama penuh dan ID anda<br>
        2Ô∏è‚É£ Klik "Detect Lokasi Saya" untuk dapatkan GPS<br>
        3Ô∏è‚É£ Pastikan anda berada dalam radius 100m dari sekolah<br>
        4Ô∏è‚É£ Klik "Check-in" bila sampai atau "Check-out" bila balik<br>
        5Ô∏è‚É£ Sistem akan auto-save lokasi dan masa anda
      </div>
     </div><!-- Action Buttons -->
     <div class="action-buttons"><button id="detectBtn" class="btn btn-info" onclick="detectLocation()"> <span>üì°</span> <span>Detect Lokasi Saya</span> </button> <button id="checkinBtn" class="btn btn-primary" onclick="handleCheckIn()" disabled> <span>‚úÖ</span> <span>Check-in</span> </button> <button id="checkoutBtn" class="btn btn-secondary" onclick="handleCheckOut()" disabled> <span>üö™</span> <span>Check-out</span> </button>
     </div>
    </div><!-- Records Section -->
    <div class="records-section">
     <div class="main-card">
      <div class="section-title"><span>üìä</span> <span>Rekod Kehadiran Terkini</span>
      </div>
      <div id="recordsList">
       <div class="empty-state">
        <div class="empty-icon">
         üì≠
        </div>
        <div>
         Tiada rekod lagi. Buat check-in pertama anda!
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </div>
  <script>
        // Configuration
        const defaultConfig = {
            system_title: "Sistem Kehadiran Geofencing",
            school_name: "Sekolah Kebangsaan",
            welcome_message: "üìç Check-in dengan lokasi GPS yang tepat!",
            primary_color: "#667eea",
            secondary_color: "#10b981",
            danger_color: "#ef4444",
            info_color: "#3b82f6",
            text_color: "#2d3748"
        };

        // School location (Kuala Lumpur city center as example - user can change)
        const SCHOOL_LOCATION = {
            lat: 3.1390,
            lng: 101.6869
        };

        const ALLOWED_RADIUS_METERS = 100; // 100 meters radius

        // Global state
        let currentLocation = null;
        let currentData = [];
        let isDetecting = false;

        // Data handler
        const dataHandler = {
            onDataChanged(data) {
                currentData = data;
                updateRecordsList();
            }
        };

        // Initialize app
        async function initializeApp() {
            // Initialize Data SDK
            const initResult = await window.dataSdk.init(dataHandler);
            if (!initResult.isOk) {
                console.error("Failed to initialize data SDK");
                showStatus("‚ùå Gagal memulakan sistem", "error");
                return;
            }

            // Initialize Element SDK
            if (window.elementSdk) {
                await window.elementSdk.init({
                    defaultConfig,
                    onConfigChange: async (config) => {
                        document.getElementById('systemTitle').textContent = 
                            config.system_title || defaultConfig.system_title;
                        document.getElementById('schoolName').textContent = 
                            config.school_name || defaultConfig.school_name;
                        document.getElementById('welcomeMessage').textContent = 
                            `üìç ${config.welcome_message || defaultConfig.welcome_message}`;
                    },
                    mapToCapabilities: (config) => ({
                        recolorables: [
                            {
                                get: () => config.primary_color || defaultConfig.primary_color,
                                set: (value) => {
                                    if (window.elementSdk) {
                                        window.elementSdk.setConfig({ primary_color: value });
                                    }
                                }
                            },
                            {
                                get: () => config.secondary_color || defaultConfig.secondary_color,
                                set: (value) => {
                                    if (window.elementSdk) {
                                        window.elementSdk.setConfig({ secondary_color: value });
                                    }
                                }
                            },
                            {
                                get: () => config.danger_color || defaultConfig.danger_color,
                                set: (value) => {
                                    if (window.elementSdk) {
                                        window.elementSdk.setConfig({ danger_color: value });
                                    }
                                }
                            },
                            {
                                get: () => config.info_color || defaultConfig.info_color,
                                set: (value) => {
                                    if (window.elementSdk) {
                                        window.elementSdk.setConfig({ info_color: value });
                                    }
                                }
                            },
                            {
                                get: () => config.text_color || defaultConfig.text_color,
                                set: (value) => {
                                    if (window.elementSdk) {
                                        window.elementSdk.setConfig({ text_color: value });
                                    }
                                }
                            }
                        ],
                        borderables: [],
                        fontEditable: undefined,
                        fontSizeable: undefined
                    }),
                    mapToEditPanelValues: (config) => new Map([
                        ["system_title", config.system_title || defaultConfig.system_title],
                        ["school_name", config.school_name || defaultConfig.school_name],
                        ["welcome_message", config.welcome_message || defaultConfig.welcome_message]
                    ])
                });
            }

            // Check GPS support
            checkGPSSupport();
        }

        // Check GPS support
        function checkGPSSupport() {
            if (!navigator.geolocation) {
                document.getElementById('gpsStatus').textContent = '‚ùå Tidak Disokong';
                showStatus("‚ùå Browser anda tidak support GPS", "error");
            } else {
                document.getElementById('gpsStatus').textContent = '‚úÖ Sedia';
            }
        }

        // Detect location
        async function detectLocation() {
            if (isDetecting) return;

            if (!navigator.geolocation) {
                showCustomModal(
                    "‚ùå GPS Tidak Disokong",
                    "Browser atau peranti anda tidak menyokong GPS. Sila guna peranti yang mempunyai GPS.",
                    "error"
                );
                return;
            }

            isDetecting = true;
            const detectBtn = document.getElementById('detectBtn');
            detectBtn.disabled = true;
            detectBtn.innerHTML = '<span class="spinner"></span><span>Mengesan lokasi...</span>';

            showStatus("üì° Sedang mengesan lokasi GPS anda...", "loading");

            try {
                const position = await new Promise((resolve, reject) => {
                    navigator.geolocation.getCurrentPosition(
                        resolve,
                        reject,
                        {
                            enableHighAccuracy: true,
                            timeout: 15000,
                            maximumAge: 0
                        }
                    );
                });

                const lat = position.coords.latitude;
                const lng = position.coords.longitude;

                currentLocation = { lat, lng };

                // Calculate distance from school
                const distance = calculateDistance(
                    SCHOOL_LOCATION.lat,
                    SCHOOL_LOCATION.lng,
                    lat,
                    lng
                );

                // Update UI
                document.getElementById('locationInfo').style.display = 'block';
                document.getElementById('currentLat').textContent = lat.toFixed(6) + '¬∞ N';
                document.getElementById('currentLng').textContent = lng.toFixed(6) + '¬∞ E';
                document.getElementById('distanceValue').textContent = distance.toFixed(0) + ' meter';

                const isInside = distance <= ALLOWED_RADIUS_METERS;
                const statusBadge = document.getElementById('locationStatus');

                if (isInside) {
                    statusBadge.textContent = '‚úÖ Dalam Kawasan Sekolah';
                    statusBadge.className = 'distance-badge distance-inside';
                    showStatus(`‚úÖ Lokasi disahkan! Anda berada ${distance.toFixed(0)}m dari sekolah`, "success");
                    
                    // Enable check-in/out buttons
                    document.getElementById('checkinBtn').disabled = false;
                    document.getElementById('checkoutBtn').disabled = false;
                } else {
                    statusBadge.textContent = '‚ùå Di Luar Kawasan';
                    statusBadge.className = 'distance-badge distance-outside';
                    showStatus(`‚ö†Ô∏è Anda berada ${distance.toFixed(0)}m dari sekolah (Had: ${ALLOWED_RADIUS_METERS}m)`, "error");
                    
                    // Disable check-in/out buttons
                    document.getElementById('checkinBtn').disabled = true;
                    document.getElementById('checkoutBtn').disabled = true;

                    showCustomModal(
                        "‚ö†Ô∏è Lokasi Tidak Sah",
                        `Anda berada ${distance.toFixed(0)} meter dari sekolah. Anda mesti berada dalam radius ${ALLOWED_RADIUS_METERS} meter untuk check-in/check-out.`,
                        "warning"
                    );
                }

            } catch (error) {
                handleLocationError(error);
            } finally {
                isDetecting = false;
                detectBtn.disabled = false;
                detectBtn.innerHTML = '<span>üì°</span><span>Detect Lokasi Saya</span>';
            }
        }

        // Handle location errors
        function handleLocationError(error) {
            let errorMsg = '';
            let errorTitle = '';

            switch (error.code) {
                case error.PERMISSION_DENIED:
                    errorTitle = 'üö´ Akses GPS Ditolak';
                    errorMsg = 'Anda perlu benarkan akses lokasi untuk guna sistem ini.\n\nCara benarkan:\n1. Pergi ke Settings peranti\n2. Cari Safari/Chrome\n3. Set Location ke "Allow"';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorTitle = 'üìç Lokasi Tidak Tersedia';
                    errorMsg = 'Sistem tidak dapat mengesan lokasi anda. Pastikan GPS dihidupkan dan anda berada di kawasan terbuka.';
                    break;
                case error.TIMEOUT:
                    errorTitle = '‚è±Ô∏è GPS Timeout';
                    errorMsg = 'Pengambilan lokasi terlalu lama. Sila cuba lagi.';
                    break;
                default:
                    errorTitle = '‚ùå Ralat GPS';
                    errorMsg = 'Berlaku ralat tidak diketahui semasa mengesan lokasi.';
            }

            showStatus(`‚ùå ${errorTitle}`, "error");
            showCustomModal(errorTitle, errorMsg, "error");
            
            document.getElementById('locationInfo').style.display = 'none';
            currentLocation = null;
        }

        // Calculate distance between two coordinates (Haversine formula)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371000; // Earth's radius in meters
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            
            const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                     Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                     Math.sin(dLon / 2) * Math.sin(dLon / 2);
            
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            const distance = R * c;
            
            return distance;
        }

        function toRad(degrees) {
            return degrees * (Math.PI / 180);
        }

        // Handle Check-in
        async function handleCheckIn() {
            await processAttendance('CHECK-IN');
        }

        // Handle Check-out
        async function handleCheckOut() {
            await processAttendance('CHECK-OUT');
        }

        // Process attendance
        async function processAttendance(actionType) {
            if (currentData.length >= 999) {
                showCustomModal(
                    "‚ö†Ô∏è Had Maksimum",
                    "Had maksimum 999 rekod telah dicapai. Sila hapus rekod lama.",
                    "warning"
                );
                return;
            }

            const name = document.getElementById('teacherName').value.trim();
            const id = document.getElementById('teacherId').value.trim();

            if (!name || !id) {
                showCustomModal(
                    "‚ö†Ô∏è Maklumat Tidak Lengkap",
                    "Sila isi nama penuh dan ID anda terlebih dahulu.",
                    "warning"
                );
                return;
            }

            if (!currentLocation) {
                showCustomModal(
                    "‚ö†Ô∏è Lokasi Tidak Dikesan",
                    "Sila klik 'Detect Lokasi Saya' terlebih dahulu untuk dapatkan lokasi GPS anda.",
                    "warning"
                );
                return;
            }

            const distance = calculateDistance(
                SCHOOL_LOCATION.lat,
                SCHOOL_LOCATION.lng,
                currentLocation.lat,
                currentLocation.lng
            );

            if (distance > ALLOWED_RADIUS_METERS) {
                showCustomModal(
                    "‚ùå Lokasi Tidak Sah",
                    `Anda berada ${distance.toFixed(0)}m dari sekolah. Anda mesti berada dalam radius ${ALLOWED_RADIUS_METERS}m.`,
                    "error"
                );
                return;
            }

            const btnId = actionType === 'CHECK-IN' ? 'checkinBtn' : 'checkoutBtn';
            const btn = document.getElementById(btnId);
            const originalHTML = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span><span>Memproses...</span>';

            showStatus(`‚è≥ Sedang merekod ${actionType.toLowerCase()}...`, "loading");

            try {
                const now = new Date();
                const record = {
                    teacher_name: name,
                    teacher_id: id,
                    action_type: actionType,
                    timestamp: now.toISOString(),
                    date: now.toLocaleDateString('ms-MY'),
                    time: now.toLocaleTimeString('ms-MY'),
                    latitude: currentLocation.lat.toFixed(6),
                    longitude: currentLocation.lng.toFixed(6),
                    location_status: '‚úÖ Dalam Kawasan',
                    distance_from_school: distance.toFixed(0) + 'm'
                };

                const result = await window.dataSdk.create(record);

                if (result.isOk) {
                    const emoji = actionType === 'CHECK-IN' ? '‚úÖ' : 'üö™';
                    showStatus(`${emoji} ${actionType} berjaya! Lokasi telah disimpan.`, "success");
                    
                    showCustomModal(
                        `${emoji} Berjaya!`,
                        `${actionType} berjaya direkod untuk ${name}.\n\nLokasi: ${currentLocation.lat.toFixed(6)}¬∞N, ${currentLocation.lng.toFixed(6)}¬∞E\nJarak: ${distance.toFixed(0)}m dari sekolah\nMasa: ${now.toLocaleTimeString('ms-MY')}`,
                        "success"
                    );

                    // Clear form
                    document.getElementById('teacherName').value = '';
                    document.getElementById('teacherId').value = '';
                    document.getElementById('locationInfo').style.display = 'none';
                    currentLocation = null;
                    
                    // Disable buttons
                    document.getElementById('checkinBtn').disabled = true;
                    document.getElementById('checkoutBtn').disabled = true;
                } else {
                    showStatus("‚ùå Gagal merekod. Sila cuba lagi.", "error");
                    showCustomModal(
                        "‚ùå Ralat",
                        "Gagal menyimpan rekod kehadiran. Sila cuba lagi.",
                        "error"
                    );
                }

            } catch (error) {
                console.error('Attendance error:', error);
                showStatus("‚ùå Ralat sistem. Sila cuba lagi.", "error");
                showCustomModal(
                    "‚ùå Ralat Sistem",
                    "Berlaku ralat semasa memproses. Sila cuba lagi.",
                    "error"
                );
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHTML;
            }
        }

        // Show status
        function showStatus(message, type) {
            const banner = document.getElementById('statusBanner');
            const icons = {
                idle: 'üìç',
                loading: '‚è≥',
                success: '‚úÖ',
                error: '‚ùå',
                warning: '‚ö†Ô∏è'
            };

            banner.innerHTML = `<span>${icons[type]}</span><span>${message}</span>`;
            banner.className = `status-banner status-${type}`;
        }

        // Show custom modal (inline replacement for alert/confirm)
        function showCustomModal(title, message, type) {
            const existingModal = document.getElementById('customModal');
            if (existingModal) {
                existingModal.remove();
            }

            const modal = document.createElement('div');
            modal.id = 'customModal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.7);
                display: flex;
                align-items: center;
                justify-content: center;
                z-index: 10000;
                padding: 20px;
            `;

            const colors = {
                success: { bg: '#d1fae5', border: '#34d399', text: '#065f46' },
                error: { bg: '#fee2e2', border: '#f87171', text: '#991b1b' },
                warning: { bg: '#fef3c7', border: '#fbbf24', text: '#92400e' }
            };

            const color = colors[type] || colors.success;

            modal.innerHTML = `
                <div style="
                    background: white;
                    padding: 30px;
                    border-radius: 20px;
                    max-width: 450px;
                    width: 100%;
                    box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                ">
                    <div style="
                        background: ${color.bg};
                        border: 3px solid ${color.border};
                        color: ${color.text};
                        padding: 20px;
                        border-radius: 12px;
                        margin-bottom: 20px;
                        font-weight: bold;
                        font-size: 1.2rem;
                        text-align: center;
                    ">${title}</div>
                    <div style="
                        color: #2d3748;
                        line-height: 1.6;
                        margin-bottom: 25px;
                        white-space: pre-line;
                    ">${message}</div>
                    <button onclick="document.getElementById('customModal').remove()" style="
                        width: 100%;
                        padding: 14px;
                        background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                        color: white;
                        border: none;
                        border-radius: 10px;
                        font-size: 1.1rem;
                        font-weight: bold;
                        cursor: pointer;
                        box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                    ">Faham</button>
                </div>
            `;

            document.body.appendChild(modal);
        }

        // Update records list
        function updateRecordsList() {
            const recordsList = document.getElementById('recordsList');

            if (currentData.length === 0) {
                recordsList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì≠</div>
                        <div>Tiada rekod lagi. Buat check-in pertama anda!</div>
                    </div>
                `;
                return;
            }

            const sortedData = [...currentData].sort((a, b) => 
                new Date(b.timestamp) - new Date(a.timestamp)
            );

            let html = '';
            sortedData.forEach(record => {
                const isCheckIn = record.action_type === 'CHECK-IN';
                html += `
                    <div class="record-card">
                        <div class="record-header">
                            <div class="record-name">${record.teacher_name}</div>
                            <div class="record-badge ${isCheckIn ? 'badge-checkin' : 'badge-checkout'}">
                                ${record.action_type}
                            </div>
                        </div>
                        <div class="record-details">
                            <strong>ID:</strong> ${record.teacher_id}<br>
                            <strong>Tarikh:</strong> ${record.date}<br>
                            <strong>Masa:</strong> ${record.time}<br>
                            <strong>Status:</strong> ${record.location_status}<br>
                            <strong>Jarak:</strong> ${record.distance_from_school}
                        </div>
                        <div class="record-location">
                            üìç ${record.latitude}¬∞N, ${record.longitude}¬∞E
                        </div>
                    </div>
                `;
            });

            recordsList.innerHTML = html;
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9bdbb9869138ad7a',t:'MTc2ODM3ODkzNy4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
